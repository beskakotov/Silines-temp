# Temperature Scanner

Скрипт, который выполняет считывание температуры с модуля SiLines RODOS-5 в ОС Linux.

## Оглавление

- [Temperature Scanner](#temperature-scanner)
  - [Оглавление](#оглавление)
  - [Зависимости](#зависимости)
  - [Системные зависимости](#системные-зависимости)
  - [Подготовка к работе](#подготовка-к-работе)
    - [Права](#права)
    - [Подготовка виртуального окружения](#подготовка-виртуального-окружения)
  - [Руководство пользователя](#руководство-пользователя)
    - [Запуск скрипта](#запуск-скрипта)
    - [Конфигурационный файл](#конфигурационный-файл)
    - [Уровни логирования](#уровни-логирования)
    - [Формат вывода](#формат-вывода)
    - [Алгоритм выполнения](#алгоритм-выполнения)

## Зависимости

- Python >= 3.7
- hidapi >= 0.11.2

## Системные зависимости

```bash
sudo apt-get update
sudo apt-get install libhidapi-dev
```

## Подготовка к работе

### Права

___

Скрипт должен выполняться от имени пользователя, который имеет права использования HID-устройства или от имени суперпользователя.

### Подготовка виртуального окружения

___

```bash
python3.7 -m venv /path/to/.venv
source /path.to/.venv/bin/activate
(.venv) python3 -m pip install -U pip setuptools wheel
(.venv) python3 -m pip install hidapi
```

## Руководство пользователя

### Запуск скрипта

___

Скрипт представляет собой файл с исходным кодом и расширением `.py`.

Пример запуска:

```bash
python3 TempScanner.py [-h] [-v] [-l LOG_LEVEL] [-r] [-c CONFIG] [-i]
```

Перечень ключей:

```sh
-h, --help          Вывод данного справочного сообщения

-v, --verbose       Включить вывод сообщений в консоль

-l LOG_LEVEL, --log-level LOG_LEVEL
                Задать уровень логирования для вывода в консоль (DEBUG, INFO, WARNING (по умолчанию), ERROR, CRITICAL)

-r, --rescan    Произвести поиск датчиков температуры независимо от поля "sensor_list" и сохранить в загруженный конфигурационный файл список их адресов.

-c CONFIG, --config CONFIG
                В качестве параметра CONFIG передается абсолютный или относительный путь до конкретного конфигурационного файла, с котороым необходимо произвести выполнение

-i, --idle      Запуск программы считывания в бесконечном цикле.

-s, --show      Данный ключ позволяет найти все доступные датчики температуры, вывести их в консоль и завершить работу скрипта.
```

Запуск без ключей приведёт к использованию стандартного конфигурационного файла и выполнению считывания температуры с указанных датчиков 1 раз.

Пример сообщения, выдаваемое при запуске с ключом `-s`:
```txt
========================================
Найдено температурных датчиков: 1. Список:
3675523769448857384
========================================
```



### Конфигурационный файл

___

Конфигурационный файл представляет собой JSON  файл с названием `TempScanner.config`.

Стандартные пути расположения конфигурационного файла:

1. Директория запуска
2. /usr/local/etc/

Пример конфигурационного файла:

```json
{
    "creation_date": "2022/04/21 13:34:14",
    "last_edit_date": "2022/04/21 14:00:58",
    "sensor_list": [
        3675523769448857384, 3675523769448857385
    ],
    "temp_file_path": "/path/to/target/directory/TEMPERATURE_SAVE_FILE.temp",
    "loggers": [
        ["TempScanner_warning.log", "WARNING"],
        ["TempScanner_debug.log", "DEBUG"]
    ],
    "reading_period": 2
}
```

>Далее в описании конфигурационного файла символом **(!)** будут указаны поля, которые обязательно должны присутствовать и без них скрипт выполнен не будет.

Подробное описание полей:

- "creation_date" - Поле, которое содержит дату создания конфигурационного файла, если он создан автоматически. В случае, если поле отсутствует - присваивается текущая дата и сохраняется в файл.
- "last_edit_date" - Поле, в котором программа сохраняет дату последнего изменения конфигурационного файла. В случае, если передан файл без данного поля будет сохранена текущая дата.
- **(!)** "sensor_list" - Поле, которое хранит в себе список **уникальных** адресов (или идентификаторов) температурных датчиков, считывание температуры с которых должно производиться. Если поле отсутствует, задано неверно или список адресов пуст - данный конфигурационный файл будет пропущен.
- **(!)** "temp_file_path" - Поле, которое содержит абсолютный путь до файла, в который необходимо вести запись считываемой температуры. В случае, если поле отсутствует или задано неверно, конфигурационный
- "loggers" - Поле, которое представляет собой список списков. Каждый вложенный список позволяет логирование с конкретным уровнем в указанный файл и состоит из двух параметров: абсолютный путь до файла и уровень логирования. По умолчанию логи сохраняются в директорию
- "reading_period" - Поле, которое содержит вещественное число, отвечающие за период считывания температуры. Указывается в секундах и имеет пределы от 1 до 600 секунд.

### Уровни логирования

___

- DEBUG - Содержит отладочную информацию.
- INFO - Содержит информацию о текущей работе скрипта.
- WARNING - предупреждения о незначительных ошибках, не вносящий значимого влияния в работу скрипта.
- ERROR - Содержит информацию об ошибках, из-за которых скрипт не может выполнить то или иное действие и вынужден прибегат к стандартным процедурам.
- CRITICAL - Содержит информацию о критических ошибках, из-за скрипт не может продолжить работу и принудительно завершается.

### Формат вывода

Файл, указанный в поле `temp_file_path` содержит информацию о текущей температуре с каждого датчика. Формат файла:
___

```txt
[25.04.2022 16:02:46] 3675523769448857384=23.3125
```

### Алгоритм выполнения

___

***Шаг 0. Считывание ключей командной строки***

В первую очередь скрипт анализирует ключи, переданные во время запуска и сохраняет их в оперативную память.

***Шаг 1. Поиск конфигурационного файла.***

1. В первую очередь, скрипт попытается использовать путь, переданный через ключ `-c` командной строки.
   - Если переданный путь проходит проверку, то скрипт инициализирует конфигурационный файл и переходит к `Шагу 2`.
   - Если переданный путь ведёт на несуществующий файл, файл с недостаточными правами доступа или с несоответствующим составом полей - скрипт вызовет критическую ошибку и остановит выполнение.
2. Скрипт ищет конфигурационные файлы с названием `TempScanner.py` в стандартных местах расположения.
   - Если конфигурационный файл найден и прошёл проверку, скрипт инициализирует его и переходит к `Шагу 2`
   - Если конфигурационный файл не проходит проверку по одному из параметров или не найден, скрипт переходит к следующему стандартному месту хранения конфигурационных файлов.
3. В случае, если путь не был передан через командную строку и не был найден в стандартных местах расположения - скрипт создаст новый стандартный конфигурационный файл автоматически, инициализирует его и сохранит в директорию, откуда был запущен.

***Шаг 2. Настройка системы логирования***

После инициализации конфигурационного файла, скрипт настраивает систему логирования, за которую отвечает класс `Logger`

***Шаг 3. Инициализация устройства***

Следующий шаг - инициализация устройства SiLines RODOS-5, с помощью которого происходит считывание температуры. Поиск происходит по следующим параметрам:

- В строке `manufacturer` хранится строка `www.masterkit.ru`.
- *VendorID* устройства равен `0x20a0`

Если подходящих устройств не найдено, то скрипт вызовет критическую ошибку и завершит работу.

***Шаг 4. Принудительный поиск датчиков***

Если скрипт запущен с ключом `-r, --rescan`, то выполняется поиск датчиков температуры и сохранение их адресов в конфигурационный файл.

***Шаг 5. Считывание температуры***

У основной части работы алгоритма есть два режима:

- Передан ключ `-i, --idle`. Скрипт переходит в режим бесконечного цикла и считывает и сохраняет в файл температуру с заданной периодичностью.
- Не передан ключ `-i, --idle`. Скрипт один раз считает и сохранит в файл температуру.
